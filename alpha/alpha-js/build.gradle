
buildscript {
    ext.jsTargetDir = file("${buildDir.path}/js")

    repositories {
        maven { url "https://plugins.gradle.org/m2/" }
    }
    dependencies {
        classpath "com.moowork.gradle:gradle-node-plugin:1.2.0"
    }
}

apply plugin: 'com.moowork.node'

dependencies {
    expectedBy project(":alpha")
    compile project(":beta:beta-js")
    compile project(":gamma:gamma-js")
}

node {
    download = true
    version = '9.4.0'
    npmVersion = '5.6.0'
    nodeModulesDir = buildDir
}

/* Install the Kotlin javascript file. */
task installKotlinJs(type: NpmTask) {
  args = ['install', '--silent', 'kotlin']
}

def kotlinJs = file("${buildDir.path}/node_modules/kotlin/kotlin.js")
def kotlinMetaJs = file("${buildDir.path}/node_modules/kotlin/kotlin.meta.js")
task copyKotlinJs(type: Copy) {
    dependsOn installKotlinJs
    from kotlinJs
    from kotlinMetaJs
    into file("${jsTargetDir.path}")
}
copyKotlinJs.doFirst {
    assert kotlinJs.exists()
    assert kotlinMetaJs.exists()
}

copyKotlinJs.dependsOn assemble
build.dependsOn copyKotlinJs

build.dependsOn installKotlinJs

task run(type: NodeTask) {
    description = "Run the Javascript code using NodeJS (no browser)"
    dependsOn build
    def pth = "${jsTargetDir.path}/${project.name}.js"
    environment NODE_PATH: jsTargetDir.path
    script = file(pth)
}
run.doFirst {
    println("run $pth with node")
}

